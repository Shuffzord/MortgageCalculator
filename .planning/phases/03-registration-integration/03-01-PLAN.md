---
phase: 03-registration-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/lib/webmcp/register.ts
  - client/src/lib/webmcp/index.ts
  - client/src/main.tsx
autonomous: true
requirements: [FR-1, FR-4]

must_haves:
  truths:
    - "Tool appears in Model Context Tool Inspector extension when page loads"
    - "Feature detection prevents errors in non-WebMCP browsers"
    - "Registration occurs automatically on app initialization"
    - "Existing calculator functionality unaffected by WebMCP registration"
  artifacts:
    - path: "client/src/lib/webmcp/register.ts"
      provides: "Registration and unregistration functions with feature detection"
      min_lines: 60
      exports: ["registerWebMCPTools", "unregisterWebMCPTools"]
    - path: "client/src/main.tsx"
      provides: "App initialization with WebMCP registration"
      contains: "registerWebMCPTools"
  key_links:
    - from: "client/src/main.tsx"
      to: "client/src/lib/webmcp/register.ts"
      via: "import and call registerWebMCPTools"
      pattern: "registerWebMCPTools\\(\\)"
    - from: "client/src/lib/webmcp/register.ts"
      to: "navigator.modelContext"
      via: "feature detection and registerTool call"
      pattern: "'modelContext' in navigator"
---

<objective>
Register the calculateMortgage tool with navigator.modelContext on page load, with feature detection for browsers without WebMCP support.

Purpose: Enable AI agents to discover and invoke the calculateMortgage tool through the browser-native WebMCP API.

Output: Tool registration module and app initialization integration that makes the tool available to AI agents in Chrome 146+ with WebMCP enabled.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-typescript-foundation/01-01-SUMMARY.md
@.planning/phases/02-calculate-tool-implementation/02-01-SUMMARY.md

# Key types from Phase 1
@client/src/lib/webmcp/types/navigator.ts
@client/src/lib/webmcp/types/tools.ts

# Tool to register from Phase 2
@client/src/lib/webmcp/tools/calculate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebMCP registration module</name>
  <files>client/src/lib/webmcp/register.ts</files>
  <action>
Create registration module that handles WebMCP tool registration and unregistration.

Feature detection:
- Check `'modelContext' in navigator` before attempting registration
- Return early if WebMCP unavailable (no errors thrown)
- Log warning in DEV mode (import.meta.env.DEV) when WebMCP unavailable

registerWebMCPTools function:
- Import allTools from '@/lib/webmcp/tools'
- Feature detection check
- For each tool in allTools:
  - Call navigator.modelContext.registerTool(tool)
  - Wrap in try-catch to handle registration errors
  - Log success/failure in DEV mode
- Return void

unregisterWebMCPTools function:
- Import allTools from '@/lib/webmcp/tools'
- Feature detection check
- For each tool in allTools:
  - Call navigator.modelContext.unregisterTool(tool.name)
  - Wrap in try-catch to handle unregistration errors
  - Log success/failure in DEV mode
- Return void

Error handling:
- Never throw errors (graceful degradation)
- Catch and log registration/unregistration failures in DEV mode
- Silent failure in production

Type safety:
- Import ModelContextTool type from '@/lib/webmcp/types'
- No `any` types except for navigator.modelContext (unavoidable - browser API)
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```

Verify allTools export exists from Phase 2:
```bash
grep "export.*allTools" client/src/lib/webmcp/tools/index.ts
```

Verify file structure:
- registerWebMCPTools function exported
- unregisterWebMCPTools function exported
- Feature detection uses 'modelContext' in navigator
- DEV mode logging present
  </verify>
  <done>
- register.ts file exists with 60+ lines
- registerWebMCPTools function exported
- unregisterWebMCPTools function exported
- Feature detection prevents errors in non-WebMCP browsers
- DEV mode logging present
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update webmcp barrel export</name>
  <files>client/src/lib/webmcp/index.ts</files>
  <action>
Update main webmcp module to export registration functions.

Add to existing exports:
```typescript
export { registerWebMCPTools, unregisterWebMCPTools } from './register';
```

This enables clean imports:
```typescript
import { registerWebMCPTools } from '@/lib/webmcp';
```

Do NOT remove existing exports (types, tools already exported from phases 1 and 2).
  </action>
  <verify>
Verify exports:
```bash
grep -E "export.*registerWebMCPTools" client/src/lib/webmcp/index.ts
grep -E "export.*unregisterWebMCPTools" client/src/lib/webmcp/index.ts
```

TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- index.ts exports registerWebMCPTools
- index.ts exports unregisterWebMCPTools
- TypeScript compiles without errors
- Existing exports preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate registration into app initialization</name>
  <files>client/src/main.tsx</files>
  <action>
Add WebMCP tool registration to app initialization.

Add import at top of file (after existing imports):
```typescript
import { registerWebMCPTools } from '@/lib/webmcp';
```

Call registration before createRoot:
```typescript
// Register WebMCP tools on page load
registerWebMCPTools();
```

Place after style injection (around line 65) and before createRoot (line 67).

Add comment explaining:
```typescript
// Register WebMCP tools on page load (Chrome 146+ with WebMCP flag enabled)
// Silently skips registration if WebMCP unavailable
registerWebMCPTools();
```

Do NOT modify existing code (HMR handlers, style injection, createRoot).
  </action>
  <verify>
Verify integration:
```bash
grep -A2 "registerWebMCPTools" client/src/main.tsx
```

App still runs:
```bash
npm run dev
```

TypeScript compiles:
```bash
npx tsc --noEmit
```

Test graceful degradation (FR-4):
- Open app in standard browser (Firefox, Safari, or Chrome without WebMCP flag)
- Verify no errors in console
- Verify calculator UI renders normally
- Verify calculations work (e.g., input values, click Calculate)
  </verify>
  <done>
- main.tsx imports registerWebMCPTools
- main.tsx calls registerWebMCPTools before createRoot
- Comment explains WebMCP registration
- App runs without errors
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
Overall verification checks:

1. TypeScript compilation:
```bash
npx tsc --noEmit
```

2. File existence:
```bash
ls client/src/lib/webmcp/register.ts
```

3. Registration functions exported:
```bash
grep "export.*registerWebMCPTools" client/src/lib/webmcp/register.ts
grep "export.*registerWebMCPTools" client/src/lib/webmcp/index.ts
```

4. App initialization integration:
```bash
grep "registerWebMCPTools" client/src/main.tsx
```

5. Feature detection present:
```bash
grep "'modelContext' in navigator" client/src/lib/webmcp/register.ts
```

6. App runs:
```bash
npm run dev
```

All must_haves verified:
- Tool registration occurs on page load (main.tsx calls registerWebMCPTools)
- Feature detection prevents errors (register.ts checks 'modelContext' in navigator)
- Existing calculator unaffected (registration is additive, non-blocking)
- Registration module exports correct functions
</verification>

<success_criteria>
Phase 3 complete when:
- [ ] register.ts exists with registerWebMCPTools and unregisterWebMCPTools functions
- [ ] Feature detection uses 'modelContext' in navigator
- [ ] DEV mode logging present for registration success/failure
- [ ] main.tsx imports and calls registerWebMCPTools
- [ ] TypeScript compiles without errors
- [ ] App runs without errors in dev mode
- [ ] No errors in browsers without WebMCP (graceful degradation)
- [ ] FR-1 (Tool Registration) acceptance criteria met
- [ ] FR-4 (Feature Detection) acceptance criteria met

Manual verification (requires Chrome 146+ with WebMCP flag):
- Open app in Chrome 146+ with chrome://flags/#enable-webmcp-testing enabled
- Open Model Context Tool Inspector extension
- Verify calculateMortgage tool appears in tool list
- Verify tool has correct name, description, inputSchema
</success_criteria>

<output>
After completion, create `.planning/phases/03-registration-integration/03-01-SUMMARY.md`
</output>
