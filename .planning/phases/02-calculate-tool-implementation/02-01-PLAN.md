---
phase: 02-calculate-tool-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/lib/webmcp/types/tools.ts
  - client/src/lib/webmcp/tools/calculate.ts
  - client/src/lib/webmcp/tools/index.ts
autonomous: true
requirements: [FR-2, FR-3, FR-5]
must_haves:
  truths:
    - "Tool accepts principal, annualInterestRate, loanTermYears and returns calculation results"
    - "Invalid inputs return structured error with field path and message"
    - "Results use existing calculationEngine and match UI calculator output"
    - "Response contains raw numeric values and full amortization schedule"
  artifacts:
    - path: "client/src/lib/webmcp/types/tools.ts"
      provides: "Updated CalculateMortgageOutput type with raw numbers only"
      contains: "amortizationSchedule"
    - path: "client/src/lib/webmcp/tools/calculate.ts"
      provides: "calculateMortgage tool definition with validation and execution"
      exports: ["calculateMortgageTool", "inputSchema"]
      min_lines: 80
    - path: "client/src/lib/webmcp/tools/index.ts"
      provides: "Barrel export for all WebMCP tools"
      exports: ["calculateMortgageTool"]
  key_links:
    - from: "client/src/lib/webmcp/tools/calculate.ts"
      to: "@/lib/calculationEngine"
      via: "import calculateLoanDetails"
      pattern: "calculateLoanDetails\\("
    - from: "client/src/lib/webmcp/tools/calculate.ts"
      to: "@/lib/webmcp"
      via: "import types"
      pattern: "import.*from.*@/lib/webmcp"
---

<objective>
Implement the calculateMortgage WebMCP tool that AI agents can invoke to perform mortgage calculations.

Purpose: Enable AI agents to calculate mortgage payments, total interest, and amortization schedules through the WebMCP API.
Output: A complete tool definition with JSON Schema, Zod validation, input mapping, and response formatting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-typescript-foundation/01-01-SUMMARY.md
@.planning/phases/02-calculate-tool-implementation/02-CONTEXT.md
@.planning/phases/02-calculate-tool-implementation/02-RESEARCH.md

# Source files needed for implementation
@client/src/lib/webmcp/types/tools.ts
@client/src/lib/webmcp/types/context.ts
@client/src/lib/calculationEngine.ts
@client/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 0: Update CalculateMortgageOutput type for raw numeric values</name>
  <files>client/src/lib/webmcp/types/tools.ts</files>
  <action>
Update the CalculateMortgageOutput interface to comply with Phase 2 CONTEXT.md locked decisions:
- Raw numeric values only (no formatted strings like "$1,703.37")
- No natural language summary field
- Full amortization schedule with numeric values

Replace the existing CalculateMortgageOutput interface with:

```typescript
/**
 * calculateMortgage tool output type
 * Raw numeric values only - agent formats for user presentation
 */
export interface CalculateMortgageOutput {
  readonly monthlyPayment: number;
  readonly totalInterest: number;
  readonly totalCost: number;
  readonly termMonths: number;
  readonly amortizationSchedule: ReadonlyArray<{
    readonly payment: number;           // Payment number (1-based)
    readonly monthlyPayment: number;
    readonly principalPayment: number;
    readonly interestPayment: number;
    readonly balance: number;
    readonly totalInterest: number;     // Cumulative
    readonly totalPayment: number;      // Cumulative
  }>;
  readonly yearlyData: ReadonlyArray<{
    readonly year: number;
    readonly principal: number;
    readonly interest: number;
    readonly payment: number;
    readonly balance: number;
    readonly totalInterest: number;
  }>;
  readonly metadata?: {
    readonly currency: string;
    readonly repaymentModel: 'equalInstallments' | 'decreasingInstallments';
    readonly calculatedAt: string;      // ISO timestamp
  };
}
```

Key changes from existing type:
- Removed `summary` object with formatted strings
- Removed `naturalLanguageSummary` field entirely
- Changed `yearlyBreakdown` to `yearlyData` with raw numbers (matches CalculationResults)
- Added full `amortizationSchedule` array with PaymentData-like structure
- Made `metadata` optional (at Claude's discretion per CONTEXT.md)
- All values are raw numbers, no string formatting
  </action>
  <verify>
Run TypeScript compilation: `cd client && npx tsc --noEmit`
Verify CalculateMortgageOutput no longer contains formatted strings or naturalLanguageSummary.
  </verify>
  <done>
CalculateMortgageOutput type uses raw numeric values only, includes amortizationSchedule array, has no naturalLanguageSummary field.
  </done>
</task>

<task type="auto">
  <name>Task 1: Create calculateMortgage tool definition</name>
  <files>client/src/lib/webmcp/tools/calculate.ts</files>
  <action>
Create the calculateMortgage WebMCP tool with all required components:

**1. JSON Schema for WebMCP registration (inputSchema):**
```typescript
export const inputSchema: JSONSchema = {
  type: 'object',
  properties: {
    principal: { type: 'number', description: 'Loan amount', minimum: 0.01 },
    annualInterestRate: { type: 'number', description: 'Annual rate as percentage (6.5 = 6.5%)', minimum: 0, maximum: 100 },
    loanTermYears: { type: 'number', description: 'Loan term in years', minimum: 1, maximum: 50 },
    currency: { type: 'string', description: 'Currency code', enum: ['USD', 'EUR', 'GBP', 'PLN'] },
    repaymentModel: { type: 'string', enum: ['equalInstallments', 'decreasingInstallments'] }
  },
  required: ['principal', 'annualInterestRate', 'loanTermYears']
};
```

**2. Zod schema for runtime validation:**
- Use `z.coerce.number()` for defensive type coercion (per RESEARCH.md recommendation)
- Custom error messages matching REQUIREMENTS.md patterns
- Defaults: currency = "USD", repaymentModel = "equalInstallments" (per CONTEXT.md)

**3. mapInputToLoanCalculationParams function:**
- Convert validated input to LoanCalculationParams format (NOT LoanDetails)
- Map single annualInterestRate to interestRatePeriods array: `[{ startMonth: 1, interestRate: annualInterestRate }]`
- Empty overpaymentPlans array (per CONTEXT.md - no overpayment in Phase 2)
- Use current date for startDate

**4. formatResponse function:**
- Return raw numeric values ONLY (per CONTEXT.md - no formatted strings like "$1,703.37")
- Include full amortizationSchedule from CalculationResults (per CONTEXT.md)
- Include yearlyData aggregated by year
- Include minimal metadata: currency, repaymentModel, calculatedAt timestamp

**5. execute function:**
- Use Zod safeParse() - never throws (per RESEARCH.md)
- On validation failure: Return FIRST error only with field path (per CONTEXT.md)
  ```typescript
  { content: [{ type: 'error', text: JSON.stringify({ field: 'principal', message: '...' }) }], error: 'VALIDATION_ERROR' }
  ```
- On success: Map input -> LoanCalculationParams -> calculateLoanDetails() -> formatResponse()

**6. Export calculateMortgageTool:**
```typescript
export const calculateMortgageTool: ModelContextTool = {
  name: toolName('calculateMortgage'),
  description: 'Calculate mortgage payments, total interest, and amortization schedule',
  inputSchema,
  readOnlyHint: true,
  execute
};
```

**Import requirements:**
- `import { z } from 'zod'`
- `import { calculateLoanDetails } from '@/lib/calculationEngine'`
- `import type { LoanCalculationParams, CalculationResults } from '@/lib/types'`
- `import { type ModelContextTool, type JSONSchema, type ToolResponse, toolName } from '@/lib/webmcp'`
  </action>
  <verify>
Run TypeScript compilation: `cd client && npx tsc --noEmit`
Verify file exports calculateMortgageTool and inputSchema.
  </verify>
  <done>
calculateMortgage tool compiles without errors, exports toolName-validated name, JSON Schema inputSchema, Zod validation schema, and async execute function that calls calculationEngine.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tools barrel export</name>
  <files>client/src/lib/webmcp/tools/index.ts</files>
  <action>
Create the tools module barrel export:

```typescript
// Re-export all WebMCP tools
export { calculateMortgageTool, inputSchema as calculateMortgageInputSchema } from './calculate';

// Export array of all available tools for registration
export const allTools = [calculateMortgageTool] as const;
```

This enables:
- Individual tool import: `import { calculateMortgageTool } from '@/lib/webmcp/tools'`
- Bulk registration: `import { allTools } from '@/lib/webmcp/tools'`
  </action>
  <verify>
Run TypeScript compilation: `cd client && npx tsc --noEmit`
Verify exports are accessible.
  </verify>
  <done>
Tools index exports calculateMortgageTool, calculateMortgageInputSchema, and allTools array.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update main webmcp barrel to include tools</name>
  <files>client/src/lib/webmcp/index.ts</files>
  <action>
Update the main webmcp module to re-export tools:

Read the existing file first, then add:
```typescript
// Tools
export { calculateMortgageTool, calculateMortgageInputSchema, allTools } from './tools';
```

This enables single-import access:
`import { calculateMortgageTool, ModelContextTool } from '@/lib/webmcp'`
  </action>
  <verify>
Run TypeScript compilation: `cd client && npx tsc --noEmit`
Verify tools are accessible from main webmcp barrel.
  </verify>
  <done>
Main webmcp module exports types AND tools, enabling `import { calculateMortgageTool } from '@/lib/webmcp'`.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd client && npx tsc --noEmit`
2. CalculateMortgageOutput type uses raw numbers only (no formatted strings)
3. CalculateMortgageOutput has no naturalLanguageSummary field
4. calculateMortgageTool is exported from @/lib/webmcp
5. inputSchema follows JSON Schema specification
6. Tool uses Zod safeParse for non-throwing validation
7. Error responses include field path and message
8. Success responses contain raw numbers (no formatted strings)
9. calculationEngine.calculateLoanDetails is called with proper LoanCalculationParams mapping
</verification>

<success_criteria>
- [ ] CalculateMortgageOutput updated: raw numbers only, no naturalLanguageSummary
- [ ] calculateMortgageTool exported with validated ToolName
- [ ] JSON Schema inputSchema defines principal, annualInterestRate, loanTermYears (required) plus optional currency, repaymentModel
- [ ] Zod validation returns first error only with {field, message} format
- [ ] Input mapped to LoanCalculationParams with interestRatePeriods array
- [ ] Response contains raw monthlyPayment, totalInterest, amortizationSchedule, yearlyData, metadata
- [ ] No formatted currency strings in response
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-calculate-tool-implementation/02-01-SUMMARY.md`
</output>
